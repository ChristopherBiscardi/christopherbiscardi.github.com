<html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title data-react-helmet="true">Chris Biscardi</title><meta data-react-helmet="true" property="description" content="Recently when implementing a Docker Registry I came across the need to
hash the incoming request body in a way that matches the‚Ä¶"/><meta data-react-helmet="true" property="og:title" content="Servant Custom Content Types"/><meta data-react-helmet="true" property="og:type" content="article"/><meta data-react-helmet="true" property="twitter:card" content="summary"/><meta data-react-helmet="true" property="twitter:title" content="Servant Custom Content Types"/><meta data-react-helmet="true" property="twitter:description" content="Recently when implementing a Docker Registry I came across the need to
hash the incoming request body in a way that matches the‚Ä¶"/><meta data-react-helmet="true" property="twitter:url" content="http://christopherbiscardi.com/servant-custom-content-types/"/><meta data-react-helmet="true" property="og:url" content="http://christopherbiscardi.com"/><meta data-react-helmet="true" property="og:description" content="Chris Biscardi builds products for startups using functional programming."/><meta data-react-helmet="true" property="og:image" content="http://christopherbiscardi.com52a032e3c73f225e5b59f4852142c624.jpeg"/><link rel="stylesheet" type="text/css" href="/styles.f25bf9e6682280946ba2e441a544b407.css"/></head><body class="landing-page"><div id="content"><div data-reactroot="" data-reactid="1" data-react-checksum="1109237766"><div class="Nav__wrapper___u7BUA" data-reactid="2"><nav class="Nav__nav___1e2Pp" data-reactid="3"><a class="Nav__logoWrapper___35yvY" href="/" data-reactid="4"><img class="Nav__logo___sw4O9" src="/69305db2985e926d498b513a21d28383.png" data-reactid="5"/></a><ul class="Nav__items___1oDCD" data-reactid="6"><li data-reactid="7"><a class="Nav__itemLink___H6Isv" href="/posts/" data-reactid="8">Posts</a></li><li data-reactid="9"><a href="https://github.com/ChristopherBiscardi/ama/issues?q=is%3Aissue+is%3Aclosed" class="Nav__itemLink___H6Isv" data-reactid="10">AMA</a></li><li data-reactid="11"><a class="Nav__itemLink___H6Isv" href="/books/" data-reactid="12">Books</a></li><li data-reactid="13"><a class="Nav__itemLink___H6Isv" href="/projects/" data-reactid="14">Projects</a></li><li data-reactid="15"><a class="Nav__itemLink___H6Isv" href="/about/" data-reactid="16">About</a></li></ul></nav></div><div data-reactid="17"><div data-reactid="18"><!-- react-empty: 19 --><div class="Hero__wrapper___1Jh63" data-reactid="20"><div class="Hero__upper___2XbdM" style="display:none;" data-reactid="21"><h1 data-reactid="22">Chris Biscardi</h1><p data-reactid="23">Haskell, React, Design, Products</p></div></div><a href="/building-a-docker-registry/" data-reactid="24"><div class="Home__stickyWrapper___SbkTs" data-reactid="25"><div class="Home__stickyInnerWrapper___2zL5P" data-reactid="26"><div class="Home__stickyMeta___3aNNY" data-reactid="27"><p class="Home__featured___2y9jS" data-reactid="28">Featured</p></div><div class="Home__stickyContent___1i1rk" data-reactid="29"><h3 data-reactid="30">Building a Docker Registry</h3><p data-reactid="31">Containers are surging right now. This series of blog posts will
explore a small corner of that universe by building a Docker Registry
that‚Ä¶</p><p class="Home__readMore___1sqG0" data-reactid="32">Read more...</p></div></div></div></a><div class="Home__postsWrapper___kkNxI" data-reactid="33"><div class="Home__posts___3ojJA" data-reactid="34"><div class="Home__post___3X9hk" data-reactid="35"><div class="PostCard__post___3wcGe" data-reactid="36"><div class="PostCard__imageHeader___2PVNg PostCard__postHeader___1KtIc" style="background-image:url(/4697ea4ccbcd2ba2f293936baed59b9d.png);" data-reactid="37"></div><div data-reactid="38"><a href="/servant-custom-content-types/" data-reactid="39"><h4 class="PostCard__heading___g30g2" data-reactid="40">Servant Custom Content Types</h4></a><span class="PostCard__meta___1oEBN" data-reactid="41"><!-- react-text: 42 -->Oct 3rd, 2016<!-- /react-text --><!-- react-text: 43 --> ‚Ä¢ <!-- /react-text --><!-- react-text: 44 -->2<!-- /react-text --><!-- react-text: 45 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="46">Recently when implementing a Docker Registry I came across the need to
hash the incoming request body in a way that matches the‚Ä¶</p><a class="PostCard__readMore___1LtB_" href="/servant-custom-content-types/" data-reactid="47">Read more...</a></div></div><div class="Home__post___3X9hk" data-reactid="48"><div class="PostCard__post___3wcGe" data-reactid="49"><div class="PostCard__imageHeader___2PVNg PostCard__postHeader___1KtIc" style="background-image:url(/da49167186a7e54073552e04d715a80f.png);" data-reactid="50"></div><div data-reactid="51"><a href="/building-a-docker-registry/" data-reactid="52"><h4 class="PostCard__heading___g30g2" data-reactid="53">Building a Docker Registry</h4></a><span class="PostCard__meta___1oEBN" data-reactid="54"><!-- react-text: 55 -->Oct 3rd, 2016<!-- /react-text --><!-- react-text: 56 --> ‚Ä¢ <!-- /react-text --><!-- react-text: 57 -->20<!-- /react-text --><!-- react-text: 58 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="59">Containers are surging right now. This series of blog posts will
explore a small corner of that universe by building a Docker Registry
that‚Ä¶</p><a class="PostCard__readMore___1LtB_" href="/building-a-docker-registry/" data-reactid="60">Read more...</a></div></div><div class="Home__post___3X9hk" data-reactid="61"><div class="PostCard__post___3wcGe" data-reactid="62"><div class="PostCard__imageHeader___2PVNg PostCard__postHeader___1KtIc" style="background-image:url(/0e564987f79346b0e81685c304af3912.png);" data-reactid="63"></div><div data-reactid="64"><a href="/response-headers-with-servant/" data-reactid="65"><h4 class="PostCard__heading___g30g2" data-reactid="66">Response Headers with Servant</h4></a><span class="PostCard__meta___1oEBN" data-reactid="67"><!-- react-text: 68 -->Aug 8th, 2016<!-- /react-text --><!-- react-text: 69 --> ‚Ä¢ <!-- /react-text --><!-- react-text: 70 -->1<!-- /react-text --><!-- react-text: 71 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="72">It can be hard to figure out how to deal with all of the type
machinery in Servant. This post details adding headers to the response
of a‚Ä¶</p><a class="PostCard__readMore___1LtB_" href="/response-headers-with-servant/" data-reactid="73">Read more...</a></div></div><div class="Home__post___3X9hk" data-reactid="74"><div class="PostCard__post___3wcGe" data-reactid="75"><div class="PostCard__imageHeader___2PVNg PostCard__postHeader___1KtIc" style="background-image:url(/4697ea4ccbcd2ba2f293936baed59b9d.png);" data-reactid="76"></div><div data-reactid="77"><a href="/instrumenting-servant-with-prometheus/" data-reactid="78"><h4 class="PostCard__heading___g30g2" data-reactid="79">Instrumenting Servant with Prometheus</h4></a><span class="PostCard__meta___1oEBN" data-reactid="80"><!-- react-text: 81 -->May 21st, 2016<!-- /react-text --><!-- react-text: 82 --> ‚Ä¢ <!-- /react-text --><!-- react-text: 83 -->2<!-- /react-text --><!-- react-text: 84 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="85">To set up a Servant/WAI application with monitoring, we will first
scaffold a servant application using stack.</p><a class="PostCard__readMore___1LtB_" href="/instrumenting-servant-with-prometheus/" data-reactid="86">Read more...</a></div></div><div class="Home__post___3X9hk" data-reactid="87"><div class="PostCard__post___3wcGe" data-reactid="88"><div class="PostCard__imageHeader___2PVNg PostCard__postHeader___1KtIc" style="background-image:url(/0e564987f79346b0e81685c304af3912.png);" data-reactid="89"></div><div data-reactid="90"><a href="/reproducible-tutorials-with-stack/" data-reactid="91"><h4 class="PostCard__heading___g30g2" data-reactid="92">Reproducible Tutorials with Stack</h4></a><span class="PostCard__meta___1oEBN" data-reactid="93"><!-- react-text: 94 -->Apr 9th, 2016<!-- /react-text --><!-- react-text: 95 --> ‚Ä¢ <!-- /react-text --><!-- react-text: 96 -->1<!-- /react-text --><!-- react-text: 97 --> minute read <!-- /react-text --></span></div><p class="PostCard__excerpt___3xWE0" data-reactid="98">Stack yields some nice benefits for blogging, tutorials, and more. The
main benefit I want to talk about today is reproducibility when‚Ä¶</p><a class="PostCard__readMore___1LtB_" href="/reproducible-tutorials-with-stack/" data-reactid="99">Read more...</a></div></div></div></div></div></div></div></div><script charset="UTF-8">window.__APOLLO_STATE__={"apollo":{"data":{"$ROOT_QUERY.root.posts({\"first\":5}).pageInfo":{"hasNextPage":true,"__typename":"PageInfo"},"$ROOT_QUERY.root.posts({\"first\":5})":{"pageInfo":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":5}).pageInfo","generated":true},"edges":[{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":5}).edges.0","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":5}).edges.1","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":5}).edges.2","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":5}).edges.3","generated":true},{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":5}).edges.4","generated":true}],"__typename":"BlogPostConnection"},"$ROOT_QUERY.root.posts({\"first\":5}).edges.0.node":{"body":"<p>Recently when implementing a Docker Registry I came across the need to\nhash the incoming request body in a way that matches the clients\nhash. Since the Docker engine is an existing client that speaks a\ncouple of different <code>Content-Type</code>s (such as\n<code>application/vnd.docker.distribution.manifest.v2+json</code>, we cannot use\nServant‚Äôs alternate content types to get a ByteString to hash. This\nleads us to one possible implementation, which is to create a new\ncontent type that uses\n<code>application/vnd.docker.distribution.manifest.v2+json</code> as the <code>Accept</code>\nheader, but also hashes the content body with <code>SHA256</code>. Our content\ntype will behave very similarly to <code>application/json</code>.</p>\n<p>We will use <a href=\"https://hackage.haskell.org/package/cryptonite\">cryptonite</a> for hashing and <a href=\"https://hackage.haskell.org/package/aeson\">Aeson</a>\nfor JSON decoding. The full code follows.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"hljs-meta\">{-# LANGUAGE FlexibleInstances     #-}</span>\n<span class=\"hljs-meta\">{-# LANGUAGE MultiParamTypeClasses #-}</span>\n<span class=\"hljs-meta\">{-# LANGUAGE OverloadedStrings     #-}</span>\n<span class=\"highlight__hljs-keyword___som98\">module</span> SR.HashedJSONContentType <span class=\"highlight__hljs-keyword___som98\">where</span>\n\n<span class=\"highlight__hljs-keyword___som98\">import</span>           Crypto.Hash                (<span class=\"highlight__hljs-type___11WfV\">Digest</span>, <span class=\"highlight__hljs-type___11WfV\">SHA256</span>)\n<span class=\"highlight__hljs-keyword___som98\">import</span>           Data.Aeson\n<span class=\"highlight__hljs-keyword___som98\">import</span> <span class=\"highlight__hljs-keyword___som98\">qualified</span> Data.ByteString.Lazy.Char8 <span class=\"highlight__hljs-keyword___som98\">as</span> BSC\n<span class=\"highlight__hljs-keyword___som98\">import</span>           Network.HTTP.Media         <span class=\"highlight__hljs-keyword___som98\">hiding</span> (<span class=\"highlight__hljs-type___11WfV\">Accept</span>)\n<span class=\"highlight__hljs-keyword___som98\">import</span>           Servant.API.ContentTypes\n\n<span class=\"highlight__hljs-keyword___som98\">import</span>           Utils                      (<span class=\"highlight__hljs-title___1fl8Q\">mkDigest</span>)\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">HashedJSON</span> = <span class=\"highlight__hljs-type___11WfV\">HashedJSON</span> <span class=\"highlight__hljs-type___11WfV\">String</span></span>\n<span class=\"highlight__hljs-class___mOeOV\">\n<span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">Accept</span> <span class=\"highlight__hljs-type___11WfV\">HashedJSON</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  contentType _ = <span class=\"highlight__hljs-string___1SffY\">\"application\"</span> // <span class=\"highlight__hljs-string___1SffY\">\"vnd.docker.distribution.manifest.v2+json\"</span>\n\n<span class=\"highlight__hljs-comment___UYk12\">-- | We don't need MimeRender for this since we are only using </span>\n<span class=\"highlight__hljs-comment___UYk12\">--   the content-type for receiving data.</span>\n<span class=\"highlight__hljs-comment___UYk12\">-- instance Show a =&gt; MimeRender HashedJSON a where</span>\n<span class=\"highlight__hljs-comment___UYk12\">--    mimeRender _ val = pack (\"This is MINE! \" ++ show val)</span>\n<span class=\"highlight__hljs-class___mOeOV\">\n<span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">FromJSON</span> a =&gt; <span class=\"highlight__hljs-type___11WfV\">MimeUnrender</span> <span class=\"highlight__hljs-type___11WfV\">HashedJSON</span> (<span class=\"highlight__hljs-type___11WfV\">Digest</span> <span class=\"highlight__hljs-type___11WfV\">SHA256</span>, <span class=\"highlight__hljs-title___1fl8Q\">a</span>) <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n   mimeUnrender _ bs = <span class=\"highlight__hljs-keyword___som98\">case</span> eitherDecodeLenient bs <span class=\"highlight__hljs-keyword___som98\">of</span>\n     <span class=\"highlight__hljs-type___11WfV\">Left</span> err -&gt; <span class=\"highlight__hljs-type___11WfV\">Left</span> err\n     <span class=\"highlight__hljs-type___11WfV\">Right</span> val -&gt; <span class=\"highlight__hljs-type___11WfV\">Right</span> (mkDigest $ <span class=\"highlight__hljs-type___11WfV\">BSC</span>.toStrict bs, val)\n</code></pre>\n<p>The most interesting part is the <code>MimeUnrender</code> instance for our\ncustom content type <code>HashedJSON</code>. Servant provides a more lenient\nversion of Aeson‚Äôs <code>decode</code> called <code>eitherDecodeLenient</code>. We use this\nfor compatibility with the normal <code>'JSON</code> content type in Servant.</p>\n<p>The instance uses a tuple <code>(Digest SHA256, a)</code> so any route types we\nwrite in the future will look similar to the following code which uses\na fake type <code>OurType</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-type___11WfV\">ReqBody</span> '[<span class=\"highlight__hljs-type___11WfV\">HashedJSON</span>] (<span class=\"highlight__hljs-type___11WfV\">Digest</span> <span class=\"highlight__hljs-type___11WfV\">SHA256</span>, <span class=\"highlight__hljs-type___11WfV\">OurType</span>) \n</code></pre>\n<p>An example handler using the above <code>ReqBody</code> declaration follows.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">putManifest</span> :: (<span class=\"highlight__hljs-type___11WfV\">CH</span>.<span class=\"highlight__hljs-type___11WfV\">Digest</span> <span class=\"highlight__hljs-type___11WfV\">CH</span>.<span class=\"highlight__hljs-type___11WfV\">SHA256</span>, <span class=\"highlight__hljs-type___11WfV\">Manifest</span>) -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">putManifest</span> (digest, manifest) = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  <span class=\"highlight__hljs-comment___UYk12\">-- do stuff with digests and manifests</span>\n  return <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<p>One can envision how changing the type of the hash in the type might\nallow us to specify which algorithm we want to use in the same way\nthat we specify <code>Manifest</code>.</p>\n","attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":5}).edges.0.node.attributes","generated":true},"__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":5}).edges.0.node.attributes":{"title":"Servant Custom Content Types","slug":"servant-custom-content-types","url":"/servant-custom-content-types/","excerpt":"Recently when implementing a Docker Registry I came across the need to\nhash the incoming request body in a way that matches the‚Ä¶","updatedAt":"Oct 3rd, 2016","timeToRead":2,"headerImage":"/4697ea4ccbcd2ba2f293936baed59b9d.png","__typename":"BlogPostAttributes"},"$ROOT_QUERY.root.posts({\"first\":5}).edges.0":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":5}).edges.0.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":5}).edges.1.node":{"body":"<p>Containers are surging right now. This series of blog posts will\nexplore a small corner of that universe by building a Docker Registry\nthat adheres to the <a href=\"https://github.com/docker/distribution/blob/bfa0a9c0973b5026d2e942dec29115c120e7f731/docs/spec/api.md\">Docker Registry HTTP V2 API</a>. The\ninformation contained in these posts will take a conceptual approach\nrather than a step-by-step approach. The code will be available in\nfull on GitHub, as the <a href=\"https://github.com/ChristopherBiscardi/superhuman-registry\">Superhuman Registry</a>.</p>\n<h1 id=\"intro\">Intro</h1>\n<p>For this project we‚Äôll use Haskell as the implementation language so\nthat we can use Servant.</p>\n<blockquote>\n<p>Servant is a set of packages for declaring web APIs at the\ntype-level and then using those API specifications to:</p>\n</blockquote>\n<ul>\n<li>write servers (this part of servant can be considered a web\nframework),</li>\n<li>obtain client functions (in Haskell),</li>\n<li>generate client functions for other programming languages,</li>\n<li>generate documentation</li>\n</ul>\n<p>Servant allows us to specify everything from request bodies to Headers\nat the type level, which will help us be explicit as we explore\nManifests, Tags and Digests. Since the purpose of this set of articles\nis informative, the types will help ground our conversations.</p>\n<h1 id=\"getting-started\">Getting Started</h1>\n<p>Firstly, we‚Äôll need a new Haskell project. <a href=\"https://www.haskellstack.org/\">Stack</a> provides\nnice templating functionality, so we‚Äôll use that to scaffold a new\nproject.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">stack</span> new servant sr <span class=\"highlight__hljs-comment___UYk12\">--resolver nightly-2016-07-31</span>\n</code></pre>\n<p>Since we aren‚Äôt focusing on Servant itself for this series, we‚Äôll\nskip a bunch of the boilerplate and backing code to focus in on the\nhandlers and business logic. The code for this section <em>is</em>\n<a href=\"https://github.com/ChristopherBiscardi/superhuman-registry/blob/861b20d317132d3ea43dc05cc03d507ca325d3e0/src/Lib.hs\">on GitHub</a> for those that want to investigate further.</p>\n<h2 id=\"routes\">Routes</h2>\n<p>One of the benefits of working from a spec is that there are a full\nset of routes already penned out for us to implement so we can achieve\ncompatibility with the wider ecosystem of tools, such as the Docker\nEngine.</p>\n<p>To start, we‚Äôll translate the routes pretty loosely. Then we‚Äôll go\nback and fill in the return types as we write each of the route\nhandlers. Translating the <a href=\"https://github.com/docker/distribution/blob/bfa0a9c0973b5026d2e942dec29115c120e7f731/docs/spec/api.md\">V2 API</a> into types looks like the\nfollowing.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">Head</span> = <span class=\"highlight__hljs-type___11WfV\">Verb</span> '<span class=\"highlight__hljs-type___11WfV\">HEAD</span> 200</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">V2Base</span> = \"v2\" :&gt; <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n  <span class=\"highlight__hljs-type___11WfV\">Header</span> \"<span class=\"highlight__hljs-type___11WfV\">Docker</span>-<span class=\"highlight__hljs-type___11WfV\">Distribution</span>-<span class=\"highlight__hljs-type___11WfV\">API</span>-<span class=\"highlight__hljs-type___11WfV\">Version</span>\" <span class=\"highlight__hljs-type___11WfV\">String</span>\n  ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)</span>\n\n<span class=\"highlight__hljs-comment___UYk12\">-- | Main API Type</span>\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">API</span> = <span class=\"highlight__hljs-type___11WfV\">V2Base</span> :&lt;|&gt; \"v2\" :&gt; <span class=\"highlight__hljs-type___11WfV\">V2API</span></span>\n\n<span class=\"highlight__hljs-comment___UYk12\">-- | V2 API Definition</span>\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">V2API</span> = <span class=\"highlight__hljs-type___11WfV\">Metadata</span></span>\n  :&lt;|&gt; <span class=\"highlight__hljs-string___1SffY\">\"_catalog\"</span> :&gt; <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">Tags</span> = \"tags\" :&gt; \"list\" :&gt; <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> </span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">Metadata</span> = <span class=\"highlight__hljs-type___11WfV\">Capture</span> \"name\" <span class=\"highlight__hljs-type___11WfV\">Name</span> :&gt; (\n  <span class=\"highlight__hljs-type___11WfV\">Tags</span> :&lt;|&gt;\n  \"<span class=\"highlight__hljs-title___1fl8Q\">manifests</span>\" :&gt; <span class=\"highlight__hljs-type___11WfV\">Manifests</span> :&lt;|&gt;\n  \"<span class=\"highlight__hljs-title___1fl8Q\">blobs</span>\" :&gt; <span class=\"highlight__hljs-type___11WfV\">Blobs</span>\n  )</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">Blobs</span> = <span class=\"highlight__hljs-type___11WfV\">Digests</span> :&lt;|&gt; <span class=\"highlight__hljs-type___11WfV\">Upload</span></span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">Manifests</span> = <span class=\"highlight__hljs-type___11WfV\">Capture</span> \"reference\" <span class=\"highlight__hljs-type___11WfV\">Ref</span> :&gt; (\n  <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n  <span class=\"highlight__hljs-type___11WfV\">Put</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n  <span class=\"highlight__hljs-type___11WfV\">Delete</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n  <span class=\"highlight__hljs-type___11WfV\">Head</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n  ) </span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">Digests</span> = <span class=\"highlight__hljs-type___11WfV\">Capture</span> \"digest\" <span class=\"highlight__hljs-type___11WfV\">Digest</span> :&gt; (\n  <span class=\"highlight__hljs-type___11WfV\">Head</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n  <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n  <span class=\"highlight__hljs-type___11WfV\">Delete</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n  )</span>\n\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">Upload</span> = \"uploads\" :&gt; (\n  <span class=\"highlight__hljs-type___11WfV\">Post</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n  <span class=\"highlight__hljs-type___11WfV\">Capture</span> \"<span class=\"highlight__hljs-title___1fl8Q\">uuid</span>\" <span class=\"highlight__hljs-type___11WfV\">UUID</span> :&gt; (\n    <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n    <span class=\"highlight__hljs-type___11WfV\">Patch</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n    <span class=\"highlight__hljs-type___11WfV\">Put</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span> :&lt;|&gt;\n    <span class=\"highlight__hljs-type___11WfV\">Delete</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n    )</span>\n  )\n</code></pre>\n<p>This produces a set of routes that lay out as follows:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>/\n‚îî‚îÄ v2/\n   ‚îú‚îÄ‚Ä¢\n   ‚îÜ\n   ‚îÜ\n   ‚îú‚îÄ &lt;capture&gt;/\n   ‚îÇ  ‚îú‚îÄ blobs/\n   ‚îÇ  ‚îÇ  ‚îú‚îÄ &lt;capture&gt;/\n   ‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ‚Ä¢\n   ‚îÇ  ‚îÇ  ‚îÇ  ‚îÜ\n   ‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ‚Ä¢\n   ‚îÇ  ‚îÇ  ‚îÇ  ‚îÜ\n   ‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ‚Ä¢\n   ‚îÇ  ‚îÇ  ‚îÜ\n   ‚îÇ  ‚îÇ  ‚îî‚îÄ uploads/\n   ‚îÇ  ‚îÇ     ‚îú‚îÄ‚Ä¢\n   ‚îÇ  ‚îÇ     ‚îÜ\n   ‚îÇ  ‚îÇ     ‚îÜ\n   ‚îÇ  ‚îÇ     ‚îî‚îÄ &lt;capture&gt;/\n   ‚îÇ  ‚îÇ        ‚îú‚îÄ‚Ä¢\n   ‚îÇ  ‚îÇ        ‚îÜ\n   ‚îÇ  ‚îÇ        ‚îú‚îÄ‚Ä¢\n   ‚îÇ  ‚îÇ        ‚îÜ\n   ‚îÇ  ‚îÇ        ‚îú‚îÄ‚Ä¢\n   ‚îÇ  ‚îÇ        ‚îÜ\n   ‚îÇ  ‚îÇ        ‚îî‚îÄ‚Ä¢\n   ‚îÇ  ‚îú‚îÄ manifests/\n   ‚îÇ  ‚îÇ  ‚îî‚îÄ &lt;capture&gt;/\n   ‚îÇ  ‚îÇ     ‚îú‚îÄ‚Ä¢\n   ‚îÇ  ‚îÇ     ‚îÜ\n   ‚îÇ  ‚îÇ     ‚îú‚îÄ‚Ä¢\n   ‚îÇ  ‚îÇ     ‚îÜ\n   ‚îÇ  ‚îÇ     ‚îú‚îÄ‚Ä¢\n   ‚îÇ  ‚îÇ     ‚îÜ\n   ‚îÇ  ‚îÇ     ‚îî‚îÄ‚Ä¢\n   ‚îÇ  ‚îî‚îÄ tags/\n   ‚îÇ     ‚îî‚îÄ list/\n   ‚îÇ        ‚îî‚îÄ‚Ä¢\n   ‚îÜ\n   ‚îî‚îÄ _catalog/\n      ‚îî‚îÄ‚Ä¢\n</code></pre>\n<p>This matches up with the spec quite well and gives us a nice base to\nstart writing more specific code without worrying about whether we‚Äôll\nmiss a route.</p>\n<h2 id=\"the-types\">The Types</h2>\n<p>If we take a closer look at the types we just wrote out we see a bunch\nof concepts including <code>Name</code>, <code>Tags</code>, <code>Manifests</code>, <code>Blobs</code>, and\n<code>Digests</code>. Interestingly, we don‚Äôt see an <code>Image</code> or <code>Container</code>\nanywhere.</p>\n<h3 id=\"name\">Name</h3>\n<p>We use <code>Name</code> to represent an repository name. <code>Name</code>s must adhere to\na specific regex (<code>[a-z0-9]+(?:[._-][a-z0-9]+)*</code>) and be less than 256\ncharacters. In plain english from the spec:</p>\n<blockquote>\n<p>A repository name is broken up into path components. A component of\na repository name must be at least one lowercase, alpha-numeric\ncharacters, optionally separated by periods, dashes or\nunderscores.</p>\n</blockquote>\n<h3 id=\"tags\">Tags</h3>\n<p><code>Tags</code> are strings that reference images. For example, if we were\nusing <code>debian</code> and wanted to only use the tag <code>jessie</code>, we could pull\nusing the format <code>debian:jessie</code>.</p>\n<h3 id=\"manifests\">Manifests</h3>\n<p>An image manifest provides a configuration and a set of\nlayers for a container image. It looks like the following JSON:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>{\n    <span class=\"highlight__hljs-string___1SffY\">\"schemaVersion\"</span>: <span class=\"highlight__hljs-number___2gmaH\">2</span>,\n    <span class=\"highlight__hljs-string___1SffY\">\"mediaType\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.distribution.manifest.v2+json\"</span>,\n    <span class=\"highlight__hljs-string___1SffY\">\"config\"</span>: {\n        <span class=\"highlight__hljs-string___1SffY\">\"mediaType\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.container.image.v1+json\"</span>,\n        <span class=\"highlight__hljs-string___1SffY\">\"size\"</span>: <span class=\"highlight__hljs-number___2gmaH\">7023</span>,\n        <span class=\"highlight__hljs-string___1SffY\">\"digest\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\"</span>\n    },\n    <span class=\"highlight__hljs-string___1SffY\">\"layers\"</span>: [\n        {\n            <span class=\"highlight__hljs-string___1SffY\">\"mediaType\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.image.rootfs.diff.tar.gzip\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"size\"</span>: <span class=\"highlight__hljs-number___2gmaH\">32654</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"digest\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f\"</span>\n        },\n        {\n            <span class=\"highlight__hljs-string___1SffY\">\"mediaType\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.image.rootfs.diff.tar.gzip\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"size\"</span>: <span class=\"highlight__hljs-number___2gmaH\">16724</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"digest\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"sha256:3c3a4604a545cdc127456d94e421cd355bca5b528f4a9c1905b15da2eb4a4c6b\"</span>\n        },\n        {\n            <span class=\"highlight__hljs-string___1SffY\">\"mediaType\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.image.rootfs.diff.tar.gzip\"</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"size\"</span>: <span class=\"highlight__hljs-number___2gmaH\">73109</span>,\n            <span class=\"highlight__hljs-string___1SffY\">\"digest\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"sha256:ec4b8955958665577945c89419d1af06b5f7636b4ac3da7f12184802ad867736\"</span>\n        }\n    ],\n}\n</code></pre>\n<h3 id=\"blobs-digests\">Blobs &amp; Digests</h3>\n<p>Layers are stored in the blob portion of the registry, keyed by\ndigest.</p>\n<h2 id=\"our-first-handler\">Our First Handler</h2>\n<p>The first route we‚Äôll look at implementing is also the most\nsimple. It‚Äôs the route that lets clients know that this registry\nimplements the V2 APIs.</p>\n<p>The type of the <code>/v2</code> route is</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">V2Base</span> = \"v2\" :&gt; <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n  <span class=\"highlight__hljs-type___11WfV\">Header</span> \"<span class=\"highlight__hljs-type___11WfV\">Docker</span>-<span class=\"highlight__hljs-type___11WfV\">Distribution</span>-<span class=\"highlight__hljs-type___11WfV\">API</span>-<span class=\"highlight__hljs-type___11WfV\">Version</span>\" <span class=\"highlight__hljs-type___11WfV\">String</span>\n  ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)</span>\n</code></pre>\n<p>Which breaks down to a <code>GET</code> request with an <code>application/json</code>\ncontent type. The response has a single header,\n<code>Docker-Distribution-API-Version</code>, which is what lets a client know\nwhich API version our registry implements. We also send back no body\ncontent. Finally, we can dig a bit deeper into <code>Get</code>, which is a type\nalias for <code>Verb 'GET 200</code>. This tells us that a successful response\nwill have a 200 code.</p>\n<p>The only other valid codes for this route <code>401 Unauthorized</code> and <code>429 Too Many Requests</code> but since we haven‚Äôt implemented authorization or\nrate-limiting, we‚Äôll skip that for now.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">v2</span> :: <span class=\"highlight__hljs-type___11WfV\">App</span> (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[<span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Distribution-API-Version\"</span> <span class=\"highlight__hljs-type___11WfV\">String</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">v2</span> = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  $(logTM) <span class=\"highlight__hljs-type___11WfV\">InfoS</span> <span class=\"highlight__hljs-string___1SffY\">\"registry/2.0\"</span>\n  return $ addHeader <span class=\"highlight__hljs-string___1SffY\">\"registry/2.0\"</span> <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<p>Our logging is pretty basic right now. We‚Äôll worry about bulking it up\nlater. For now, we‚Äôre going to leave the default Katip stdout which\nleaves us with time, loglevel, hostname (container id), thread id and\nsource location:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>[2016-08-08 21:47:50][superhuman-registry][Info][85f79bec070f][33][ThreadId 11][sr-0.1.0.0-61fGnb6tOFbKD5fzBNSxKr:Lib src/Lib.hs:63:5] registry/2.0\n</code></pre>\n<h1 id=\"dealing-with-layers\">Dealing with Layers</h1>\n<p>The primary purpose of a Registry is to store layers and manifests so\na client (such as a Docker Engine) can pull images. We‚Äôll avoid\nsupporting legacy versions of the registry for security and simplicity\nreasons, which means our registry will only work for docker 1.10 and\nabove. Benefits of this include not having to rewrite v2 manifests\ninto the v1 format.</p>\n<h2 id=\"docker-client\">Docker Client</h2>\n<p>We need to figure out what the docker is doing on a push. Since I‚Äôm\nrunning Docker for Mac, booting a server to act as a registry is\npretty simple. We‚Äôll use <code>nc</code> for a first attempt.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>docker run -itp 9000:9000 alpine nc -l 9000\n</code></pre>\n<p>Now that we have a server acting as a ‚Äúregistry‚Äù, we need to tag and\npush an image to it.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; docker tag hello-world localhost:9000/hello-world\n&gt; docker push localhost:9000/hello-world\nThe push refers to a repository [localhost:9000/hello-world]\nPut http://localhost:9000/v1/repositories/hello-world/: EOF\n</code></pre>\n<p>Great! Our server is listening and the engine is pushing to the right\nplace. If it wasn‚Äôt, we could‚Äôve seen something like this:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>Put http://localhost:9000/v1/repositories/hello-world/: read tcp\n[::1]:56492-&gt;[::1]:9000: read: connection reset by peer\n</code></pre>\n<p>There‚Äôs a problem though, <code>nc</code> doesn‚Äôt implement the <code>/v2/</code> endpoint,\nso the docker client falls back to v1 of the api. Luckily, we‚Äôve\nimplemented the v2 endpoint already so we‚Äôll skip netcat and jump back\ninto Haskell.</p>\n<p>We can use <code>Wai.Middleware.RequestLogger</code> to log out everything docker\ntries to do to our registry. Using docker-compose to boot up our\nregistry and re-attempting the push yields:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>api_1  | GET /v2/\napi_1  |   Accept:\napi_1  |   Status: 200 OK 0.000190373s\napi_1  | Prelude.undefined\napi_1  | CallStack (from HasCallStack):\napi_1  |   error, called at libraries/base/GHC/Err.hs:79:14 in base:GHC.Err\napi_1  |   undefined, called at src/SR/Blobs.hs:26:14 in sr-0.1.0.0-5isXdkrmBvbJTFdJY734op:SR.Blobs\napi_1  | Prelude.undefined\napi_1  | CallStack (from HasCallStack):\napi_1  |   error, called at libraries/base/GHC/Err.hs:79:14 in base:GHC.Err\napi_1  |   undefined, called at src/SR/Blobs.hs:26:14 in sr-0.1.0.0-5isXdkrmBvbJTFdJY734op:SR.Blobs\n</code></pre>\n<p>From the information, we see that the <code>/v2/</code> route is working as\nexpected, but we hit <code>undefined</code> at <code>src/SR/Blobs.hs:26:14</code>, which is\ntotally expected because we haven‚Äôt implemented <code>uploadBlob</code>\nyet. Notice that the engine retries the upload request.</p>\n<p>If the route didn‚Äôt exist, we would have seen a 404 in the logs.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>api_1  | GET /v2/\napi_1  |   Accept:\napi_1  |   Status: 200 OK 0.011277359s\napi_1  | POST /v2/hello-world/blobs/uploads/\napi_1  |   Accept:\napi_1  |   Status: 404 Not Found 0.000028066s\n</code></pre>\n<p>This matches with what we know about the\n<a href=\"https://github.com/docker/distribution/blob/dea554fc7cce2f2e7af5b1e1d38e28c5e96e1d9e/docs/spec/api.md#starting-an-upload\">upload process</a>.</p>\n<h2 id=\"uploadblob\">uploadBlob</h2>\n<p>We can throw a couple print statements in to replace the undefined as\nsuch:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">uploadBlob</span> :: <span class=\"highlight__hljs-type___11WfV\">Namespace</span> -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span> -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n<span class=\"highlight__hljs-title___1fl8Q\">uploadBlob</span> namespace' name' = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  liftIO $ print namespace'\n  liftIO $ print name'\n  return <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<p>Which will yield us some progress when trying to push.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>api_1  | GET /v2/\napi_1  |   Accept:\napi_1  |   Status: 200 OK 0.004299263s\napi_1  | Namespace &quot;lib&quot;\napi_1  | Name &quot;hello-world&quot;\napi_1  | POST /v2/lib/hello-world/blobs/uploads/\napi_1  |   Accept:\napi_1  |   Status: 200 OK 0.000105174s\n</code></pre>\n<p>This is good progress, but we clearly have some issues since the\ndocker engine is still retrying the endpoint.</p>\n<p>There are two approaches to blob upload\n<a href=\"https://github.com/docker/distribution/blob/b1b100cf011b037b8821e8d0ae4f5ab3e2222c48/docs/spec/api.md#initiate-monolithic-blob-upload\">monolithic</a> and\n<a href=\"https://github.com/docker/distribution/blob/b1b100cf011b037b8821e8d0ae4f5ab3e2222c48/docs/spec/api.md#initiate-resumable-blob-upload\">resumeable</a>. The docs for\n<code>/v2/&lt;name&gt;/blobs/uploads</code> detail that the digest query param is the\ndifferentiator between monolithic and resumable upload.</p>\n<blockquote>\n<p>Initiate a resumable blob upload. If successful, an upload location\nwill be provided to complete the upload. Optionally, if the digest\nparameter is present, the request body will be used to complete the\nupload in a single request.</p>\n</blockquote>\n<p>Let‚Äôs take a look at an implementation for the <code>uploadBlob</code>\n(<code>&lt;&gt;/blobs/uploads</code>) route. We modifiy the type to reflect the various\nheaders and response codes (docker engine is a picky client). All of\nthe relevant information is communicated through headers, so we return\n<code>NoContent</code> as well. <code>PostAccepted</code> is a shortcut for <code>202</code> responses.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-type___11WfV\">PostAccepted</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n  <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Location\"</span> <span class=\"highlight__hljs-type___11WfV\">URI</span>,\n  <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Range\"</span> <span class=\"highlight__hljs-type___11WfV\">String</span>,\n  <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Upload-UUID\"</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n</code></pre>\n<p>Now the handler code. We generate a new uuid to send back in the\nresponse. Our first go is just trying to get the docker client to\ncontinue to the next request but in the future we should do something\nwith the uuid so we can respond to status requests. <code>uploadAPI</code> might\nlook scary, but it‚Äôs just specifying the route we want to generate for\nthe <code>Location</code> header. We do this so that Servant will automatically\ncheck that the route is valid for the <code>api</code> we are serving and we get\na compile error if it doesn‚Äôt typecheck.</p>\n<p>We add 3 headers, setting the Range to <code>&quot;0-0&quot;</code> because we are only\nresponding to resumable upload requests for now. (Otherwise we‚Äôd have\nto handle the case of an extra query string parameter). Once we\ngenerate the <code>Location</code> and the <code>Docker-Upload-UUID</code>, we send them\nback so the docker engine can start uploading blobs at the specified\n<code>Location</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">uploadBlob</span> :: <span class=\"highlight__hljs-type___11WfV\">Namespace</span> -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span> -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Location\"</span> <span class=\"highlight__hljs-type___11WfV\">URI</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Range\"</span> <span class=\"highlight__hljs-type___11WfV\">String</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Upload-UUID\"</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n  ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">uploadBlob</span> namespace' name' = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  uuid &lt;- liftIO $ nextRandom\n  <span class=\"highlight__hljs-keyword___som98\">let</span> uploadAPI = <span class=\"highlight__hljs-type___11WfV\">Proxy</span> :: <span class=\"highlight__hljs-type___11WfV\">Proxy</span> (<span class=\"highlight__hljs-string___1SffY\">\"v2\"</span> :&gt; <span class=\"highlight__hljs-type___11WfV\">Capture</span> <span class=\"highlight__hljs-string___1SffY\">\"namespace\"</span> <span class=\"highlight__hljs-type___11WfV\">Namespace</span> :&gt; <span class=\"highlight__hljs-type___11WfV\">Capture</span> <span class=\"highlight__hljs-string___1SffY\">\"name\"</span> <span class=\"highlight__hljs-type___11WfV\">Name</span> :&gt; <span class=\"highlight__hljs-string___1SffY\">\"blobs\"</span> :&gt; <span class=\"highlight__hljs-string___1SffY\">\"uploads\"</span> :&gt; <span class=\"highlight__hljs-type___11WfV\">Capture</span> <span class=\"highlight__hljs-string___1SffY\">\"uuid\"</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span> :&gt; <span class=\"highlight__hljs-type___11WfV\">Put</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n      mkURI = safeLink api uploadAPI\n      uri = mkURI namespace' name' uuid\n      response = addHeader uri\n        $ addHeader <span class=\"highlight__hljs-string___1SffY\">\"0-0\"</span>\n        $ addHeader uuid <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n  $(logTM) <span class=\"highlight__hljs-type___11WfV\">InfoS</span> (logStr $ show $ getHeaders response)\n  return response\n</code></pre>\n<p>We also need a couple instances which allow us to render types like\n<code>UUID</code> into path components and headers. (note: these are orphan\ninstances, but we could fix that by using a newtype and declaring the\ninstances for the newtypes instead).</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">FromHttpApiData</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  parseUrlPiece text = <span class=\"highlight__hljs-keyword___som98\">case</span> (fromText text) <span class=\"highlight__hljs-keyword___som98\">of</span>\n    <span class=\"highlight__hljs-type___11WfV\">Nothing</span> -&gt; <span class=\"highlight__hljs-type___11WfV\">Left</span> $ <span class=\"highlight__hljs-type___11WfV\">T</span>.append <span class=\"highlight__hljs-string___1SffY\">\"Invalid UUID\"</span> text\n    <span class=\"highlight__hljs-type___11WfV\">Just</span> uuid -&gt; <span class=\"highlight__hljs-type___11WfV\">Right</span> uuid\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">ToByteString</span> <span class=\"highlight__hljs-type___11WfV\">URI</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  builder = lazyByteString . pack . show\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">ToHttpApiData</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  toUrlPiece = toText\n  toHeader = toASCIIBytes\n<span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">ToByteString</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  builder = lazyByteString . toLazyASCIIBytes\n</code></pre>\n<p>We push again to test the route</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>docker push localhost:9000/lib/hello-world\n</code></pre>\n<p>And voil√†, we get the desired effect. The docker engine accepts the\nUUID and tries to upload blobs to <code>PATCH /v2/lib/hello-world/blobs/uploads/v2/lib/hello-world/blobs/uploads/aeab6f5e-4b80-4c7b-9027-616b1cbe6a55</code>. That‚Äôs\ntotally not the right URI though. We‚Äôve accidentally used a relative\nURI in our <code>Location</code> header. We‚Äôll fix that though üòÉ</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>GET /v2/\n  Accept:\n  Status: 200 OK 0.000458567s\n[2016-08-30 18:12:49][superhuman-registry][Info][b4fa86e02706][6258][ThreadId 15][sr-0.1.0.0-4uXdy03mbpG98AEB4xHfiO:SR.Blobs src/SR/Blobs.hs:47:5] [(&quot;Location&quot;,&quot;v2/lib/hello-world/blobs/uploads/aeab6f5e-4b80-4c7b-9027-616b1cbe6a55&quot;),(&quot;Range&quot;,&quot;0-0&quot;),(&quot;Docker-Upload-UUID&quot;,&quot;aeab6f5e-4b80-4c7b-9027-616b1cbe6a55&quot;)]\nPOST /v2/lib/hello-world/blobs/uploads/\n  Accept:\n  Status: 202 Accepted 0.000303745s\nPATCH /v2/lib/hello-world/blobs/uploads/v2/lib/hello-world/blobs/uploads/aeab6f5e-4b80-4c7b-9027-616b1cbe6a55\n  Accept:\n  Status: 404 Not Found 0.000041239s\n</code></pre>\n<h2 id=\"patchblob\">patchBlob</h2>\n<p>The <a href=\"https://github.com/docker/distribution/blob/41f383fb9a3b4e3ff428a92db4f7836f8053058b/docs/spec/api.md#patch-blob-upload\">next route</a>, as shown in the logs above, is\nthe <code>PATCH</code> to the <code>Location</code> header we sent back down. The type for\nthe <code>PATCH</code> route changes to:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-type___11WfV\">ReqBody</span> '[<span class=\"highlight__hljs-type___11WfV\">OctetStream</span>] <span class=\"highlight__hljs-type___11WfV\">ByteString</span> :&gt;\n  <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"range\"</span> <span class=\"highlight__hljs-type___11WfV\">String</span> :&gt;\n  <span class=\"highlight__hljs-type___11WfV\">PatchNoContent</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Location\"</span> <span class=\"highlight__hljs-type___11WfV\">URI</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Range\"</span> <span class=\"highlight__hljs-type___11WfV\">String</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Upload-UUID\"</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n  ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n</code></pre>\n<p>We need to accept and echo back the <code>Range</code> header, while the request\nbody comes in as an <code>OctetStream</code>. We take this information and just\nwrite out the <code>OctetStream</code> to a file for now.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">patchBlob</span> :: <span class=\"highlight__hljs-type___11WfV\">Namespace</span>\n          -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span>\n          -&gt; <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n          -&gt; <span class=\"highlight__hljs-type___11WfV\">ByteString</span>\n          -&gt; <span class=\"highlight__hljs-type___11WfV\">Maybe</span> <span class=\"highlight__hljs-type___11WfV\">String</span>\n          -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Location\"</span> <span class=\"highlight__hljs-type___11WfV\">URI</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Range\"</span> <span class=\"highlight__hljs-type___11WfV\">String</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Upload-UUID\"</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n  ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">patchBlob</span> namespace' name' uuid' blob range' = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  liftIO $ <span class=\"highlight__hljs-type___11WfV\">Data</span>.<span class=\"highlight__hljs-type___11WfV\">ByteString</span>.writeFile (<span class=\"highlight__hljs-string___1SffY\">\"./tmp/\"</span> ++ toString uuid') blob\n  response &lt;- mkHeaders range' uuid' namespace' name'\n  return response\n</code></pre>\n<p>With this code (and another upload attempt from the engine), we can\nsee that the next request is a <code>PUT</code>, which indicates the last request\nfor this layer.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>GET /v2/\n  Accept:\n  Status: 200 OK 0.005978465s\n[2016-09-03 20:21:39][superhuman-registry][Info][b4fa86e02706][130][ThreadId 14][sr-0.1.0.0-7Q5s7SCyVcbA5o0UAD7J0W:SR.Blobs src/SR/Blobs.hs:74:5] [(&quot;Location&quot;,&quot;http://localhost:9000/v2/lib/hello-world/blobs/uploads/f525cc29-b588-417b-aac2-85c5752ce07b&quot;),(&quot;Range&quot;,&quot;0-0&quot;),(&quot;Docker-Upload-UUID&quot;,&quot;f525cc29-b588-417b-aac2-85c5752ce07b&quot;)]\nPOST /v2/lib/hello-world/blobs/uploads/\n  Accept:\n  Status: 202 Accepted 0.000442272s\nPATCH /v2/lib/hello-world/blobs/uploads/f525cc29-b588-417b-aac2-85c5752ce07b\n  Accept:\n  Status: 204 No Content 0.012519558s\nPUT /v2/lib/hello-world/blobs/uploads/f525cc29-b588-417b-aac2-85c5752ce07b\n  Params: [(&quot;digest&quot;,&quot;sha256:a9d36faac0fe2a855f798346f33bd48917bf3af9b6e4b77870ef8862fee8a8a3&quot;)]\n  Accept:\n  Status: 200 OK 0.000077408s\n</code></pre>\n<h2 id=\"putblob\">putBlob</h2>\n<p>After <code>PATCH</code>s finish flowing in, the client sends a <code>PUT</code> request\nwith the digest and potentially any final layer content. Note that at\nthis point, we have not implemented any append functionality so our\n<code>PATCH</code> endpoint will only work for small layers. Likewise, our <code>PUT</code>\nand the <code>HEAD</code> that comes after it will be very minimal, omitting\ncritical functionality. This is so that we can get through all of the\nrequests and confirm a full upload flow.</p>\n<p>The <code>Digest</code> for a layer is a sha256 hash as such:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>sha256:6c3c624b58dbbcd3c0dd82b4c53f04194d1247c6eebdaab7c610cf7d66709b3b\n</code></pre>\n<p>Our handler will just emit <code>NoContent</code> so we can skip the validation\ncode and get on with groking the entire request flow.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">putBlob</span> :: <span class=\"highlight__hljs-type___11WfV\">Namespace</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">Maybe</span> <span class=\"highlight__hljs-type___11WfV\">Digest</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n<span class=\"highlight__hljs-title___1fl8Q\">putBlob</span> namespace' name' uuid' digest' = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  <span class=\"highlight__hljs-keyword___som98\">case</span> digest' <span class=\"highlight__hljs-keyword___som98\">of</span>\n    <span class=\"highlight__hljs-type___11WfV\">Nothing</span> -&gt; return <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n    <span class=\"highlight__hljs-type___11WfV\">Just</span> a -&gt; return <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<h2 id=\"headdigest\">headDigest</h2>\n<p>This is getting familiar, so we will move on to a minimal <code>HEAD</code> which\nis a request to check to see if a particular layer (identified by\n<code>Digest</code>) has been uploaded. Our version responds ‚Äúyes‚Äù to every\nsingle <code>HEAD</code> request, indicating that the layer exists in the\nregistry already. Luckily for us the Docker client doesn‚Äôt seem to\nvalidate the <code>Content-Length</code> header which means we can just echo the\n<code>Digest</code> back in a header and call it done.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">headDigest</span> :: <span class=\"highlight__hljs-type___11WfV\">Namespace</span>\n           -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span>\n           -&gt; <span class=\"highlight__hljs-type___11WfV\">Digest</span>\n           -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Content-Length\"</span> <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Content-Digest\"</span> <span class=\"highlight__hljs-type___11WfV\">Digest</span>\n    ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">headDigest</span> namespace' name' digest' = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  return $ addHeader <span class=\"highlight__hljs-number___2gmaH\">0</span>\n         $ addHeader digest' <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<h2 id=\"putmanifest\">putManifest</h2>\n<p>With the rest of the pieces in place, we receive a <code>PUT</code> to upload the\n<code>Manifest</code> for an image. When uploading the <code>Manifest</code> for an image,\nit is interesting to note that this is the first reference to a <code>Tag</code>\nthat we have seen so far. In this case, it is <code>latest</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>PUT /v2/lib/hello-world/manifests/latest\n</code></pre>\n<p>It is also interesting to remind ourselves that <code>docker pull</code> works if\nwe use the sha256 hash of the <code>Manifest</code>. To see this in action let‚Äôs\ngrab the sha for <code>hello-world</code>, which we‚Äôve been using to test our\nregistry.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; docker inspect <span class=\"hljs-_\">-f</span> <span class=\"highlight__hljs-string___1SffY\">\"{{ .RepoDigests}}\"</span> hello-world\n[hello-world@sha256:0256e8a36e2070f7bf2d0b0763dbabdd67798512411de4cdcf9431a1feb60fd9]\n&gt; docker pull hello-world@sha256:0256e8a36e2070f7bf2d0b0763dbabdd67798512411de4cdcf9431a1feb60fd9\nsha256:0256e8a36e2070f7bf2d0b0763dbabdd67798512411de4cdcf9431a1feb60fd9: Pulling from library/hello-world\nDigest: sha256:0256e8a36e2070f7bf2d0b0763dbabdd67798512411de4cdcf9431a1feb60fd9\nStatus: Image is up to date <span class=\"highlight__hljs-keyword___som98\">for</span> hello-world@sha256:0256e8a36e2070f7bf2d0b0763dbabdd67798512411de4cdcf9431a1feb60fd9\n</code></pre>\n<p>This is useful because a <code>Reference</code>, which is the final path segment\nin the <code>PUT</code> URL, can be a <code>Digest</code> OR a <code>Tag</code>. We need to know this\nbecause the response headers need the <code>Digest</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>201 Created\nLocation: &lt;url&gt;\nContent-Length: 0\nDocker-Content-Digest: &lt;digest&gt;\n</code></pre>\n<h3 id=\"manifests\">Manifests</h3>\n<p>The <code>Manifest</code> for <code>hello-world</code> is a\n<a href=\"https://github.com/docker/distribution/blob/master/docs/spec/manifest-v2-2.md#image-manifest-field-descriptions\">v2+json</a>\nstyle manifest. The other major option for us is going to be a\nManifest List, aka a Fat Manifest. Our <code>Manifest</code> looks as the\nfollowing, with a single layer.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>{\n   <span class=\"highlight__hljs-string___1SffY\">\"schemaVersion\"</span>: <span class=\"highlight__hljs-number___2gmaH\">2</span>,\n   <span class=\"highlight__hljs-string___1SffY\">\"mediaType\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.distribution.manifest.v2+json\"</span>,\n   <span class=\"highlight__hljs-string___1SffY\">\"config\"</span>: {\n      <span class=\"highlight__hljs-string___1SffY\">\"mediaType\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.container.image.v1+json\"</span>,\n      <span class=\"highlight__hljs-string___1SffY\">\"digest\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"sha256:c54a2cc56cbb2f04003c1cd4507e118af7c0d340fe7e2720f70976c4b75237dc\"</span>\n   },\n   <span class=\"highlight__hljs-string___1SffY\">\"layers\"</span>: [\n      {\n         <span class=\"highlight__hljs-string___1SffY\">\"mediaType\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.image.rootfs.diff.tar.gzip\"</span>,\n         <span class=\"highlight__hljs-string___1SffY\">\"size\"</span>: <span class=\"highlight__hljs-number___2gmaH\">1</span>,\n         <span class=\"highlight__hljs-string___1SffY\">\"digest\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"sha256:c04b14da8d1441880ed3fe6106fb2cc6fa1c9661846ac0266b8a5ec8edf37b7c\"</span>\n      }\n   ]\n}\n</code></pre>\n<p>We can parse the above <code>Manifest</code> JSON into the following Haskell\ndatatype. In the future we can also do digest validation for each\ndigest in the manifest.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-type___11WfV\">V2_2</span> {\n  schemaVersion = <span class=\"highlight__hljs-number___2gmaH\">2</span>,\n  mediaType = <span class=\"highlight__hljs-type___11WfV\">Manifest_V2_JSON</span>,\n  config = <span class=\"highlight__hljs-type___11WfV\">Config</span> {\n      cMediaType = <span class=\"highlight__hljs-type___11WfV\">V1_JSON</span>,\n      cSize = <span class=\"highlight__hljs-number___2gmaH\">7023</span>,\n      cDigest = <span class=\"highlight__hljs-string___1SffY\">\"sha256:b5b2b2c507a0944348e0303114d8d93aaaa081732b86451d9bce1f432a537bc7\"</span>\n      },\n  layers = [\n      <span class=\"highlight__hljs-type___11WfV\">Layer</span> {\n          lMediaType = <span class=\"highlight__hljs-type___11WfV\">Diff</span>,\n          lSize = <span class=\"highlight__hljs-number___2gmaH\">32654</span>,\n          lDigest = <span class=\"highlight__hljs-string___1SffY\">\"sha256:e692418e4cbaf90ca69d05a66403747baa33ee08806650b51fab815ad7fc331f\"</span>,\n          lUrls = <span class=\"highlight__hljs-type___11WfV\">Nothing</span>\n          },\n      <span class=\"highlight__hljs-type___11WfV\">Layer</span> {\n          lMediaType = <span class=\"highlight__hljs-type___11WfV\">Diff</span>,\n          lSize = <span class=\"highlight__hljs-number___2gmaH\">16724</span>,\n          lDigest = <span class=\"highlight__hljs-string___1SffY\">\"sha256:3c3a4604a545cdc127456d94e421cd355bca5b528f4a9c1905b15da2eb4a4c6b\"</span>,\n          lUrls = <span class=\"highlight__hljs-type___11WfV\">Nothing</span>\n          },\n      <span class=\"highlight__hljs-type___11WfV\">Layer</span> {\n          lMediaType = <span class=\"highlight__hljs-type___11WfV\">Diff</span>,\n          lSize = <span class=\"highlight__hljs-number___2gmaH\">73109</span>,\n          lDigest = <span class=\"highlight__hljs-string___1SffY\">\"sha256:ec4b8955958665577945c89419d1af06b5f7636b4ac3da7f12184802ad867736\"</span>,\n          lUrls = <span class=\"highlight__hljs-type___11WfV\">Nothing</span>\n          }\n      ]\n  }\n</code></pre>\n<p>For us, it is important to note how the mechanics behind backward\ncompatibility work.</p>\n<blockquote>\n<p>When pushing images, clients which support the new manifest format\nshould first construct a manifest in the new format.</p>\n</blockquote>\n<p>Which is great for us because that means we only have to code support\nfor v2 manifests and compatible clients will behave appropriately.</p>\n<h3 id=\"implementing-the-handler\">Implementing the Handler</h3>\n<p>At this point, it‚Äôs useful to set up a proxy. After doing that, we can\nlog out arbitrary parts of the requests/responses to find the\nfollowing headers coming from the docker engine request to <code>putManifest</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>{\n  <span class=\"highlight__hljs-string___1SffY\">\"connection\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"close\"</span>,\n  <span class=\"highlight__hljs-string___1SffY\">\"accept-encoding\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"gzip\"</span>,\n  <span class=\"highlight__hljs-string___1SffY\">\"content-type\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"application/vnd.docker.distribution.manifest.v2+json\"</span>,\n  <span class=\"highlight__hljs-string___1SffY\">\"content-length\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"482\"</span>,\n  <span class=\"highlight__hljs-string___1SffY\">\"user-agent\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"docker/1.12.1 go/go1.6.3 git-commit/23cf638 kernel/4.4.20-moby os/linux arch/amd64 UpstreamClient(Docker-Client/1.12.1 \\\\(darwin\\\\))\"</span>,\n  <span class=\"highlight__hljs-string___1SffY\">\"host\"</span>: <span class=\"highlight__hljs-string___1SffY\">\"localhost:8000\"</span>\n}\n</code></pre>\n<p>The one we <em>really</em> care about is the <code>Content-Type</code> header. The\nrequest identifies the type of <code>Manifest</code> based on the <code>Content-Type</code>,\nso we can easily handle different <code>Manifest</code> content. To add support\nfor the <code>vnd.docker.distribution.manifest.v2+json</code> <code>Content-Type</code>, we\ncan write the implementation for a new Servant <code>Content-Type</code>.</p>\n<p><a href=\"/servant-custom-content-types/\">Read More on Custom Content-Types</a></p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">data</span> <span class=\"highlight__hljs-type___11WfV\">HashedJSON</span> = <span class=\"highlight__hljs-type___11WfV\">HashedJSON</span> <span class=\"highlight__hljs-type___11WfV\">String</span></span>\n<span class=\"highlight__hljs-class___mOeOV\">\n<span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">Accept</span> <span class=\"highlight__hljs-type___11WfV\">HashedJSON</span> <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  contentType _ = <span class=\"highlight__hljs-string___1SffY\">\"application\"</span> // <span class=\"highlight__hljs-string___1SffY\">\"vnd.docker.distribution.manifest.v2+json\"</span>\n<span class=\"highlight__hljs-class___mOeOV\">\n<span class=\"highlight__hljs-keyword___som98\">instance</span> <span class=\"highlight__hljs-type___11WfV\">FromJSON</span> a =&gt; <span class=\"highlight__hljs-type___11WfV\">MimeUnrender</span> <span class=\"highlight__hljs-type___11WfV\">HashedJSON</span> (<span class=\"highlight__hljs-type___11WfV\">Digest</span> <span class=\"highlight__hljs-type___11WfV\">SHA256</span>, <span class=\"highlight__hljs-title___1fl8Q\">a</span>) <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n   mimeUnrender _ bs = <span class=\"highlight__hljs-keyword___som98\">case</span> eitherDecodeLenient bs <span class=\"highlight__hljs-keyword___som98\">of</span>\n     <span class=\"highlight__hljs-type___11WfV\">Left</span> err -&gt; <span class=\"highlight__hljs-type___11WfV\">Left</span> err\n     <span class=\"highlight__hljs-type___11WfV\">Right</span> val -&gt; <span class=\"highlight__hljs-type___11WfV\">Right</span> (mkLazyDigest bs, val)\n</code></pre>\n<p>Note that we have also included the ability to hash the incoming\ncontent with this <code>Content-Type</code>. This means our handlers don‚Äôt have\nto worry about dealing with hashing.</p>\n<p>Our route with the new <code>Content-Type</code> looks like the following, where\n<code>CH</code> comes from the <a href=\"https://hackage.haskell.org/package/cryptonite\">cryptonite</a> package. The request body\nis specified as a tuple of <code>(Digest, Manfiest)</code> which comes from the\n<code>HashedJSON</code> <code>Content-Type</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>  <span class=\"highlight__hljs-type___11WfV\">ReqBody</span> '[<span class=\"highlight__hljs-type___11WfV\">HashedJSON</span>] (<span class=\"highlight__hljs-type___11WfV\">CH</span>.<span class=\"highlight__hljs-type___11WfV\">Digest</span> <span class=\"highlight__hljs-type___11WfV\">CH</span>.<span class=\"highlight__hljs-type___11WfV\">SHA256</span>, <span class=\"highlight__hljs-type___11WfV\">Manifest</span>) :&gt;\n    <span class=\"highlight__hljs-type___11WfV\">PutCreated</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n      <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Content-Length\"</span> <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n      <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Content-Digest\"</span> <span class=\"highlight__hljs-type___11WfV\">CDigest</span>\n      ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n</code></pre>\n<p>We are still doing as little work as possible in the handler.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">putManifest</span> :: <span class=\"highlight__hljs-type___11WfV\">Namespace</span>\n            -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span>\n            -&gt; <span class=\"highlight__hljs-type___11WfV\">Ref</span>\n            -&gt; (<span class=\"highlight__hljs-type___11WfV\">CH</span>.<span class=\"highlight__hljs-type___11WfV\">Digest</span> <span class=\"highlight__hljs-type___11WfV\">CH</span>.<span class=\"highlight__hljs-type___11WfV\">SHA256</span>, <span class=\"highlight__hljs-type___11WfV\">Manifest</span>)\n            -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Content-Length\"</span> <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Content-Digest\"</span> <span class=\"highlight__hljs-type___11WfV\">CDigest</span>\n    ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">putManifest</span> namespace' name ref' (digest, manifest) = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  liftIO $ print <span class=\"highlight__hljs-string___1SffY\">\"putManifest\"</span>\n  liftIO $ print digest\n  return $ addHeader <span class=\"highlight__hljs-number___2gmaH\">0</span>\n         $ addHeader (<span class=\"highlight__hljs-type___11WfV\">CDigest</span> digest) <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<p>Success!</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&quot;putManifest&quot;\n6741f4d4187d8b5bcdf338c6a8dbbef12604e31211b3f57e4873f623f64dba80\nPUT /v2/biscarch/hello-world/manifests/latest\n  Request Body: {\n   &quot;schemaVersion&quot;: 2,\n   &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,\n   &quot;config&quot;: {\n      &quot;mediaType&quot;: &quot;application/vnd.docker.container.image.v1+json&quot;,\n      &quot;digest&quot;: &quot;sha256:c54a2cc56cbb2f04003c1cd4507e118af7c0d340fe7e2720f70976c4b75237dc&quot;\n   },\n   &quot;layers&quot;: [\n      {\n         &quot;mediaType&quot;: &quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;,\n         &quot;digest&quot;: &quot;sha256:c04b14da8d1441880ed3fe6106fb2cc6fa1c9661846ac0266b8a5ec8edf37b7c&quot;\n      }\n   ]\n}\n  Accept:\n  Status: 201 Created 0.000758785s\n</code></pre>\n<hr>\n<h1 id=\"a-gadt-rises\">A GADT Rises</h1>\n<p>Now that we have a fully ‚Äúworking‚Äù image upload (at least, the docker\nengine is convinced we handled everything correctly), we have two ways\nforward.</p>\n<ol>\n<li>Truly implement <code>push</code> compatibility complete with resumable\nupload, etc.</li>\n<li>Execute the same ‚Äúas little as possible‚Äù process to complete a\n<code>docker pull</code>.</li>\n</ol>\n<p>Since we eventually we want to support multiple backends, Option 1\nwill have to happen in the future. To do this, we would start off with\na GADT that defines the various operations that need to be implemented\nfor a new backend.</p>\n<p>To refresh, here is the list of handlers we need to implement for\n<code>push</code> compatibility.</p>\n<ul>\n<li>uploadBlob</li>\n<li>patchBlob</li>\n<li>putBlob</li>\n<li>headDigest</li>\n<li>putManifest</li>\n</ul>\n<p>What we want in the end is a Generalized Algebraic Data Type that\ndefines what it means to be a <code>RegistryBackend</code>. An example\ndeclaration for the <code>uploadBlob</code> functionality shows that a compliant\nbackend would need to declare a function which too a <code>RepoName</code>,\n<code>UUID</code>, <code>Maybe Digest</code> and returned an <code>Either UploadError NoContent</code>. We would use <code>UploadError</code> to restrict the types of errors\nwhich come back so we can communicate with exists clients such as the\nDocker engine.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">class</span> <span class=\"highlight__hljs-type___11WfV\">RegistryBackend</span> b <span class=\"highlight__hljs-keyword___som98\">where</span></span>\n  uploadBlob :: b\n             -&gt; <span class=\"highlight__hljs-type___11WfV\">RepoName</span>\n             -&gt; <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n             -&gt; <span class=\"highlight__hljs-type___11WfV\">Maybe</span> <span class=\"highlight__hljs-type___11WfV\">Digest</span>\n             -&gt; <span class=\"highlight__hljs-type___11WfV\">Either</span> <span class=\"highlight__hljs-type___11WfV\">UploadError</span> <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n  ...\n</code></pre>\n<p>This involves a couple of pieces including changing our handler types\nfrom the following (which uses <code>App</code> directly).</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">putBlob</span> :: <span class=\"highlight__hljs-type___11WfV\">Namespace</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">Maybe</span> <span class=\"highlight__hljs-type___11WfV\">Digest</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<p>to something more general. Possibly just a <code>HasRegistryBackend</code>\nconstraint on the monad (<code>App</code> is also a monad).</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">putBlob</span> :: ( <span class=\"highlight__hljs-type___11WfV\">KatipContext</span> m, <span class=\"highlight__hljs-type___11WfV\">RegistryBackend</span> m )\n        =&gt; <span class=\"highlight__hljs-type___11WfV\">Namespace</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n        -&gt; <span class=\"highlight__hljs-type___11WfV\">Maybe</span> <span class=\"highlight__hljs-type___11WfV\">Digest</span>\n        -&gt; m <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<p>This would allow us to move configuration of the server into the\nexecutables while still allowing the library to provide guarentees\nabout what it needs to be able to function. In effect, allowing us to\nbuild binaries that target Postgres, File Systems, and other\ninteresting data stores.</p>\n<p>We will keep this in mind as we move forward with a concrete\nimplementation based on Postgres. This concrete implementation will\ninform us as to which abstractions make sense. An interesting choice\nfor the second store implementation would be something without\ntransactions and different consistency guarentees such as S3 or a KV\nstore.</p>\n<h1 id=\"postgres-uploadblob\">Postgres uploadBlob</h1>\n<p>Since we now need a ‚Äúreal‚Äù backend, we‚Äôll spin up Postgres using\n<a href=\"http://sqitch.org/\">sqitch</a> for migrations. The official Postgres image allows us\nto use a shell script to initialize the db so all we need to do in\naddition is install sqitch:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>FROM postgres\n\nRUN apt-get update &amp;&amp; apt-get install sqitch -y\n\nCOPY . /opt/sqitch\nWORKDIR /opt/sqitch\n\nCOPY ./initdb.sh /docker-entrypoint-initdb.d/initdb.sh\n</code></pre>\n<p><a href=\"https://github.com/ChristopherBiscardi/superhuman-registry/blob/9508e1b1b6887c8d4e412fad0ddd8f89676f8192/sqitch/initdb.sh\">initdb.sh</a>\nis the following script to execute sqitch:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>#!/bin/bash\nset -e\n\ncd /opt/sqitch &amp;&amp; sqitch -u &quot;$POSTGRES_USER&quot; deploy --verify\n</code></pre>\n<p>The migrations (in order) are the following three. The first sets up\nour SR schema.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-comment___UYk12\">-- Deploy sr:appschema to pg</span>\n\n<span class=\"highlight__hljs-keyword___som98\">BEGIN</span>;\n\n<span class=\"highlight__hljs-keyword___som98\">CREATE</span> <span class=\"highlight__hljs-keyword___som98\">SCHEMA</span> sr;\n\n<span class=\"highlight__hljs-keyword___som98\">COMMIT</span>;\n</code></pre>\n<p>The second registers uuid-ossp, which we will use when tracking upload\nrequests.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-comment___UYk12\">-- Deploy sr:uuid-ossp to pg</span>\n<span class=\"highlight__hljs-comment___UYk12\">-- requires: appschema</span>\n\n<span class=\"highlight__hljs-keyword___som98\">BEGIN</span>;\n\n<span class=\"highlight__hljs-keyword___som98\">CREATE</span> EXTENSION <span class=\"highlight__hljs-string___1SffY\">\"uuid-ossp\"</span>;\n\n<span class=\"highlight__hljs-keyword___som98\">COMMIT</span>;\n</code></pre>\n<p>Finally, we implement a table with automatic <code>created_at</code> and\n<code>modified_at</code> timestamps. These timestamps will help us implement\ngarbage collection for abandoned uploads. We let Postgres handle\ngeneration of unique UUIDs on <code>INSERT</code> and leave the creation of a\nLarge Object for the future.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-comment___UYk12\">-- Deploy sr:blob-uploads to pg</span>\n<span class=\"highlight__hljs-comment___UYk12\">-- requires: uuid-ossp</span>\n\n<span class=\"highlight__hljs-keyword___som98\">BEGIN</span>;\n\n<span class=\"highlight__hljs-comment___UYk12\">-- Table</span>\n<span class=\"highlight__hljs-keyword___som98\">CREATE</span> <span class=\"highlight__hljs-keyword___som98\">TABLE</span> sr.blob_uploads (\n  <span class=\"highlight__hljs-keyword___som98\">id</span> <span class=\"highlight__hljs-keyword___som98\">UUID</span> PRIMARY <span class=\"highlight__hljs-keyword___som98\">KEY</span> <span class=\"highlight__hljs-keyword___som98\">DEFAULT</span> uuid_generate_v4(),\n  lo_id <span class=\"highlight__hljs-keyword___som98\">OID</span>,\n  repo_name <span class=\"highlight__hljs-built_in___3uuyR\">VARCHAR</span>(<span class=\"highlight__hljs-number___2gmaH\">256</span>) <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>,\n  created_at <span class=\"highlight__hljs-keyword___som98\">TIMESTAMP</span> <span class=\"highlight__hljs-keyword___som98\">WITH</span> <span class=\"highlight__hljs-keyword___som98\">TIME</span> ZONE <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>,\n  modified_at <span class=\"highlight__hljs-keyword___som98\">TIMESTAMP</span> <span class=\"highlight__hljs-keyword___som98\">WITH</span> <span class=\"highlight__hljs-keyword___som98\">TIME</span> ZONE <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>\n);\n\n<span class=\"highlight__hljs-comment___UYk12\">-- Automatically update modified_at</span>\n<span class=\"highlight__hljs-keyword___som98\">CREATE</span> <span class=\"highlight__hljs-keyword___som98\">OR</span> <span class=\"highlight__hljs-keyword___som98\">REPLACE</span> <span class=\"highlight__hljs-keyword___som98\">FUNCTION</span> update_modified_column()\n<span class=\"highlight__hljs-keyword___som98\">RETURNS</span> <span class=\"highlight__hljs-keyword___som98\">TRIGGER</span> <span class=\"highlight__hljs-keyword___som98\">AS</span> $$\n<span class=\"highlight__hljs-keyword___som98\">BEGIN</span>\n    NEW.modified_at = <span class=\"highlight__hljs-keyword___som98\">now</span>();\n    <span class=\"highlight__hljs-comment___UYk12\">-- Force created_at to never change</span>\n    NEW.created_at = OLD.created_at;\n    RETURN NEW;\n<span class=\"highlight__hljs-keyword___som98\">END</span>;\n$$ language 'plpgsql';\n\n<span class=\"highlight__hljs-keyword___som98\">CREATE</span> <span class=\"highlight__hljs-keyword___som98\">TRIGGER</span> update_blob_upload_modtime\n<span class=\"highlight__hljs-keyword___som98\">BEFORE</span> <span class=\"highlight__hljs-keyword___som98\">UPDATE</span> <span class=\"highlight__hljs-keyword___som98\">ON</span> sr.blob_uploads\n<span class=\"highlight__hljs-keyword___som98\">FOR</span> <span class=\"highlight__hljs-keyword___som98\">EACH</span> <span class=\"highlight__hljs-keyword___som98\">ROW</span> <span class=\"highlight__hljs-keyword___som98\">EXECUTE</span> <span class=\"highlight__hljs-keyword___som98\">PROCEDURE</span> update_modified_column();\n\n<span class=\"highlight__hljs-comment___UYk12\">-- | Automatically populate created_at</span>\n<span class=\"highlight__hljs-comment___UYk12\">-- Use a trigger so it's impossible to override on insert</span>\n<span class=\"highlight__hljs-keyword___som98\">CREATE</span> <span class=\"highlight__hljs-keyword___som98\">OR</span> <span class=\"highlight__hljs-keyword___som98\">REPLACE</span> <span class=\"highlight__hljs-keyword___som98\">FUNCTION</span> populate_create_column()\n<span class=\"highlight__hljs-keyword___som98\">RETURNS</span> <span class=\"highlight__hljs-keyword___som98\">TRIGGER</span> <span class=\"highlight__hljs-keyword___som98\">AS</span> $$\n<span class=\"highlight__hljs-keyword___som98\">BEGIN</span>\n    NEW.created_at = <span class=\"highlight__hljs-keyword___som98\">now</span>();\n    NEW.modified_at = now();\n    RETURN NEW;\t\n<span class=\"highlight__hljs-keyword___som98\">END</span>;\n$$ language 'plpgsql';\n\n<span class=\"highlight__hljs-keyword___som98\">CREATE</span> <span class=\"highlight__hljs-keyword___som98\">TRIGGER</span> insert_blob_upload_createtime\n<span class=\"highlight__hljs-keyword___som98\">BEFORE</span> <span class=\"highlight__hljs-keyword___som98\">INSERT</span> <span class=\"highlight__hljs-keyword___som98\">ON</span> sr.blob_uploads\n<span class=\"highlight__hljs-keyword___som98\">FOR</span> <span class=\"highlight__hljs-keyword___som98\">EACH</span> <span class=\"highlight__hljs-keyword___som98\">ROW</span> <span class=\"highlight__hljs-keyword___som98\">EXECUTE</span> <span class=\"highlight__hljs-keyword___som98\">PROCEDURE</span> populate_create_column();\n\n<span class=\"highlight__hljs-keyword___som98\">COMMIT</span>;\n</code></pre>\n<p>To handle the initialization of new uploads, we use the following\nquery which grabs a connection from the pool, executes the statement\nand returns the UUID of the new upload.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-comment___UYk12\">-- | Insert a new upload for a Repos</span>\n<span class=\"highlight__hljs-title___1fl8Q\">startNewUpload</span> :: <span class=\"highlight__hljs-type___11WfV\">Reponame</span> -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n<span class=\"highlight__hljs-title___1fl8Q\">startNewUpload</span> repo = runPG (query repo insertNewUpload)\n\n<span class=\"highlight__hljs-comment___UYk12\">-- | PG automatically creates uuid, created_at and modified_at</span>\n<span class=\"highlight__hljs-title___1fl8Q\">insertNewUpload</span> :: <span class=\"highlight__hljs-type___11WfV\">Query</span> <span class=\"highlight__hljs-type___11WfV\">Text</span> <span class=\"highlight__hljs-type___11WfV\">UUID</span>\n<span class=\"highlight__hljs-title___1fl8Q\">insertNewUpload</span> =\n  statement sql encoder decoder <span class=\"highlight__hljs-type___11WfV\">True</span>\n  <span class=\"highlight__hljs-keyword___som98\">where</span>\n    sql =\n      <span class=\"highlight__hljs-string___1SffY\">\"INSERT INTO sr.blob_uploads (repo_name) VALUES ($1) RETURNING id\"</span>\n    encoder =\n      <span class=\"highlight__hljs-type___11WfV\">E</span>.value <span class=\"highlight__hljs-type___11WfV\">E</span>.text\n    decoder =\n      <span class=\"highlight__hljs-type___11WfV\">D</span>.singleRow (<span class=\"highlight__hljs-type___11WfV\">D</span>.value <span class=\"highlight__hljs-type___11WfV\">D</span>.uuid)\n</code></pre>\n<p><code>runPG</code> is a utility function which handles any connection\nerrors.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">runPG</span> :: <span class=\"highlight__hljs-type___11WfV\">Session</span> a -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> a\n<span class=\"highlight__hljs-title___1fl8Q\">runPG</span> action = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  pool &lt;- asks acPGPool\n  res &lt;- liftIO $ <span class=\"highlight__hljs-type___11WfV\">P</span>.use pool action\n  <span class=\"highlight__hljs-keyword___som98\">case</span> res <span class=\"highlight__hljs-keyword___som98\">of</span>\n    <span class=\"highlight__hljs-type___11WfV\">Left</span> usageError -&gt; <span class=\"highlight__hljs-keyword___som98\">do</span>\n    ...\n</code></pre>\n<h1 id=\"postgres-headblob\">Postgres headBlob</h1>\n<p>At this point I figured out that Docker will ask to mount if you push\nan image, then retag it and push the retagged image.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>docker tag hello-world localhost:9000/biscarch/hello-worlds\ndocker push localhost:9000/biscarch/hello-worlds\ndocker tag hello-world localhost:9000/biscarch/hello-world-2\ndocker push localhost:9000/biscarch/hello-world-2\n</code></pre>\n<p>The last push produces the following request to blob upload:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>GET /v2/\n  Accept:\n  Status: 200 OK 0.002441185s\nPOST /v2/biscarch/hello-world-2/blobs/uploads/\n  Params: [(&quot;from&quot;,&quot;biscarch/hello-worlds&quot;),(&quot;mount&quot;,&quot;sha256:c04b14da8d1441880ed3fe6106fb2cc6fa1c9661846ac0266b8a5ec8edf37b7c&quot;)]\n  Accept:\n</code></pre>\n<p>To implement <code>putBlob</code> we‚Äôll need to make our hacky <code>headBlob</code> return\n404s. This gives us a nice spot to implement a <code>blobs</code> table which\nwill form the basis of our <code>catalog</code>.</p>\n<p>TODO: implement CREATE TABLE <code>blobs</code> here.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-comment___UYk12\">-- Table</span>\n<span class=\"highlight__hljs-keyword___som98\">CREATE</span> <span class=\"highlight__hljs-keyword___som98\">TABLE</span> sr.blobs (\n  <span class=\"highlight__hljs-comment___UYk12\">-- id is a sha256 hash</span>\n  <span class=\"highlight__hljs-comment___UYk12\">-- <span class=\"hljs-doctag\">TODO:</span> limit this to sha256 length?</span>\n  <span class=\"highlight__hljs-keyword___som98\">id</span> <span class=\"highlight__hljs-built_in___3uuyR\">TEXT</span> PRIMARY <span class=\"highlight__hljs-keyword___som98\">KEY</span>,\n  <span class=\"highlight__hljs-comment___UYk12\">-- id of the hashed blob</span>\n  lo_id <span class=\"highlight__hljs-keyword___som98\">OID</span>,\n  <span class=\"highlight__hljs-comment___UYk12\">-- maybe remove repo_name?</span>\n  repo_name <span class=\"highlight__hljs-built_in___3uuyR\">VARCHAR</span>(<span class=\"highlight__hljs-number___2gmaH\">256</span>) <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>,\n  created_at <span class=\"highlight__hljs-keyword___som98\">TIMESTAMP</span> <span class=\"highlight__hljs-keyword___som98\">WITH</span> <span class=\"highlight__hljs-keyword___som98\">TIME</span> ZONE <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>,\n  modified_at <span class=\"highlight__hljs-keyword___som98\">TIMESTAMP</span> <span class=\"highlight__hljs-keyword___som98\">WITH</span> <span class=\"highlight__hljs-keyword___som98\">TIME</span> ZONE <span class=\"highlight__hljs-keyword___som98\">NOT</span> <span class=\"highlight__hljs-literal___1V6TY\">NULL</span>\n);\n</code></pre>\n<p>Our <code>HEAD</code> handler will check to see if the blob exists in our\n<code>catalog</code>. If it does, we need to get the <code>Content-Length</code> of the blob\nto return. If it does not exist we just 404.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">headDigest</span> :: <span class=\"highlight__hljs-type___11WfV\">Namespace</span>\n           -&gt; <span class=\"highlight__hljs-type___11WfV\">Name</span>\n           -&gt; <span class=\"highlight__hljs-type___11WfV\">Digest</span>\n           -&gt; <span class=\"highlight__hljs-type___11WfV\">App</span> (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Content-Length\"</span> <span class=\"highlight__hljs-type___11WfV\">Int</span>,\n    <span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"Docker-Content-Digest\"</span> <span class=\"highlight__hljs-type___11WfV\">Digest</span>\n    ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">headDigest</span> namespace' name' digest' = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  blobExists &lt;- headBlob digest'\n  <span class=\"highlight__hljs-keyword___som98\">case</span> blobExists <span class=\"highlight__hljs-keyword___som98\">of</span>\n    <span class=\"highlight__hljs-type___11WfV\">BLOB_EXISTS</span> d' -&gt; return addHeader <span class=\"highlight__hljs-number___2gmaH\">0</span>\n                    $ addHeader digest' <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n    <span class=\"highlight__hljs-type___11WfV\">UNKNOWN_BLOB</span> -&gt; throwError err404\n</code></pre>\n<h1 id=\"fixing-patchblob\">Fixing patchBlob</h1>\n<h1 id=\"postgres-putblob\">Postgres putBlob</h1>\n","attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":5}).edges.1.node.attributes","generated":true},"__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":5}).edges.1.node.attributes":{"title":"Building a Docker Registry","slug":"building-a-docker-registry","url":"/building-a-docker-registry/","excerpt":"Containers are surging right now. This series of blog posts will\nexplore a small corner of that universe by building a Docker Registry\nthat‚Ä¶","updatedAt":"Oct 3rd, 2016","timeToRead":20,"headerImage":"/da49167186a7e54073552e04d715a80f.png","__typename":"BlogPostAttributes"},"$ROOT_QUERY.root.posts({\"first\":5}).edges.1":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":5}).edges.1.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":5}).edges.2.node":{"body":"<p>It can be hard to figure out how to deal with all of the type\nmachinery in Servant. This post details adding headers to the response\nof a Servant API.</p>\n<p>Given the following API, which returns NoContent for a GET request.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">V2</span> = \"v2\" :&gt; <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span></span>\n</code></pre>\n<p>and the following handler, which assumes we‚Äôve set up a custom Monad\nstack called <code>App</code> (note that we‚Äôve skipped the ‚Äúserver‚Äù boilerplate\nfor brevity, since it is covered in the Servant docs).</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">v2</span> :: <span class=\"highlight__hljs-type___11WfV\">App</span> <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n<span class=\"highlight__hljs-title___1fl8Q\">v2</span> = return <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<p>We can add a response header using <a href=\"http://hackage.haskell.org/package/servant-0.8/docs/Servant-API-ResponseHeaders.html#v:addHeader\">addHeader</a>, which is\ndetailed in the docs on Hackage. What may be less obvious is that\naddHeader changes the response type of the route. Our simple API\nchanges it‚Äôs type to represent the new return value:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">V2Base</span> = \"v2\" :&gt; <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[<span class=\"highlight__hljs-type___11WfV\">Header</span> \"<span class=\"highlight__hljs-type___11WfV\">X</span>-<span class=\"highlight__hljs-type___11WfV\">Awesome</span>\" <span class=\"highlight__hljs-type___11WfV\">String</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)</span>\n</code></pre>\n<p>and our handler now can return the appropriate type as well:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">v2</span> :: <span class=\"highlight__hljs-type___11WfV\">App</span> (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[<span class=\"highlight__hljs-type___11WfV\">Header</span> <span class=\"highlight__hljs-string___1SffY\">\"X-Awesome\"</span> <span class=\"highlight__hljs-type___11WfV\">String</span>] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)\n<span class=\"highlight__hljs-title___1fl8Q\">v2</span> = return $ addHeader <span class=\"highlight__hljs-string___1SffY\">\"very/awesome\"</span> <span class=\"highlight__hljs-type___11WfV\">NoContent</span>\n</code></pre>\n<h2 id=\"multiple-headers\">Multiple Headers</h2>\n<p>If we inspect the type we added to be able to return our first header,\nwe can notice that it is a list of <code>Header</code>s. We can use this to add\nmultiple new headers to our route as follows:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-class___mOeOV\"><span class=\"highlight__hljs-keyword___som98\">type</span> <span class=\"highlight__hljs-type___11WfV\">V2Base</span> = \"v2\" :&gt; <span class=\"highlight__hljs-type___11WfV\">Get</span> '[<span class=\"highlight__hljs-type___11WfV\">JSON</span>] (<span class=\"highlight__hljs-type___11WfV\">Headers</span> '[\n  <span class=\"highlight__hljs-type___11WfV\">Header</span> \"<span class=\"highlight__hljs-type___11WfV\">X</span>-<span class=\"highlight__hljs-type___11WfV\">Awesome</span>\" <span class=\"highlight__hljs-type___11WfV\">String</span>,\n  <span class=\"highlight__hljs-type___11WfV\">Header</span> \"<span class=\"highlight__hljs-type___11WfV\">Content</span>-<span class=\"highlight__hljs-type___11WfV\">Type</span>\" <span class=\"highlight__hljs-type___11WfV\">String</span>\n  ] <span class=\"highlight__hljs-type___11WfV\">NoContent</span>)</span>\n</code></pre>\n","attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":5}).edges.2.node.attributes","generated":true},"__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":5}).edges.2.node.attributes":{"title":"Response Headers with Servant","slug":"response-headers-with-servant","url":"/response-headers-with-servant/","excerpt":"It can be hard to figure out how to deal with all of the type\nmachinery in Servant. This post details adding headers to the response\nof a‚Ä¶","updatedAt":"Aug 8th, 2016","timeToRead":1,"headerImage":"/0e564987f79346b0e81685c304af3912.png","__typename":"BlogPostAttributes"},"$ROOT_QUERY.root.posts({\"first\":5}).edges.2":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":5}).edges.2.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":5}).edges.3.node":{"body":"<p>To set up a Servant/WAI application with monitoring, we will first\nscaffold a servant application using stack.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>&gt; stack new servant-prometheus \\\nhttps://raw.githubusercontent.com/commercialhaskell/stack-templates/8cb4889fb7c502c18f6f9ecf9<span class=\"highlight__hljs-built_in___3uuyR\">cd</span>62aef58589c21/servant.hsfiles \\\n--resolver nightly-2016-05-21\n</code></pre>\n<p>To instrument our servant application, add the following three\ndependencies to <code>servant-prometheus.cabal</code> under the <code>build-depends</code>\nof the <code>library</code>.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>, wai-middleware-prometheus &gt;= <span class=\"highlight__hljs-number___2gmaH\">0.1</span><span class=\"highlight__hljs-number___2gmaH\">.0</span><span class=\"highlight__hljs-number___2gmaH\">.1</span>\n, prometheus-client &gt;= <span class=\"highlight__hljs-number___2gmaH\">0.1</span><span class=\"highlight__hljs-number___2gmaH\">.0</span><span class=\"highlight__hljs-number___2gmaH\">.1</span>\n, prometheus-metrics-ghc &gt;= <span class=\"highlight__hljs-number___2gmaH\">0.1</span><span class=\"highlight__hljs-number___2gmaH\">.0</span><span class=\"highlight__hljs-number___2gmaH\">.1</span>\n</code></pre>\n<p>In <code>src/Lib.hs</code> we need the following 3 imports. They are fully\nqualified for clarity.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-keyword___som98\">import</span> Network.Wai.Middleware.Prometheus (<span class=\"highlight__hljs-title___1fl8Q\">prometheus</span>, <span class=\"highlight__hljs-type___11WfV\">PrometheusSettings(..)</span>)\n<span class=\"highlight__hljs-keyword___som98\">import</span> Prometheus (<span class=\"highlight__hljs-title___1fl8Q\">register</span>)\n<span class=\"highlight__hljs-keyword___som98\">import</span> Prometheus.Metric.GHC (<span class=\"highlight__hljs-title___1fl8Q\">ghcMetrics</span>)\n</code></pre>\n<p>All of our work will be in the <code>startApp</code> function defined in the same\nfile. Currently, <code>startApp</code> is defined as <code>run 8080 app</code>. We are going\nto change that to the following.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code><span class=\"highlight__hljs-title___1fl8Q\">startApp</span> = <span class=\"highlight__hljs-keyword___som98\">do</span>\n  register ghcMetrics\n  <span class=\"highlight__hljs-keyword___som98\">let</span> promMiddleware = prometheus $ <span class=\"highlight__hljs-type___11WfV\">PrometheusSettings</span> [<span class=\"highlight__hljs-string___1SffY\">\"metrics\"</span>] <span class=\"highlight__hljs-type___11WfV\">True</span> <span class=\"highlight__hljs-type___11WfV\">True</span>\n  run <span class=\"highlight__hljs-number___2gmaH\">8080</span> $ promMiddleware $ app\n</code></pre>\n<p>We also need <code>{-# LANGUAGE OverloadedStrings #-}</code> for the\n<code>[&quot;metrics&quot;]</code> literal.</p>\n<p>Finally, to actually enable consumption of GHC metrics, we need to\ninclude the <code>-T</code> flag in our executable. The <code>executable</code>'s\n<code>ghc-options</code> becomes:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>ghc-options: -threaded -rtsopts -with-rtsopts=-TN\n</code></pre>\n<p>After building and running, the servant server should be providing\nprometheus metrics at /metrics.</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>stack install --only-dependencies\nstack build\nstack <span class=\"highlight__hljs-built_in___3uuyR\">exec</span> servant-prometheus-exe\n</code></pre>\n<h1 id=\"details\">Details</h1>\n<p>All three of the packages we added as dependencies come from\n<a href=\"https://github.com/fimad/prometheus-haskell\">fimad/prometheus-haskell</a>.</p>\n<ul>\n<li>Prometheus Client\n<ul>\n<li>Defines the core data types and metrics. The other two packages\nbuild on client to provide their metrics.</li>\n<li>This is the package to use to set up custom metrics.</li>\n</ul>\n</li>\n<li>Prometheus Metrics GHC\n<ul>\n<li>Provides a set of custom metrics for Prometheus Client that are\nexposed from GHC‚Äôs runtime system.</li>\n</ul>\n</li>\n<li>WAI Middleware Prometheus\n<ul>\n<li>Instruments a WAI application, exposing common HTTP metrics. Also\nexposes those metrics on /metrics (or the url of the user‚Äôs\nchoice)</li>\n</ul>\n</li>\n</ul>\n<p><a href=\"http://localhost:8080/metrics\">localhost:8080/metrics</a> should now\nhave the following output, which can be scraped by Prometheus.</p>\n<ul>\n<li><code>http_</code> prefixed metrics come from the WAI middleware</li>\n<li><code>ghc_</code> prefixed metrics come from <code>ghcMetrics</code></li>\n</ul>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code># HELP http_request_duration_microseconds The HTTP request latencies in microseconds.\n# TYPE http_request_duration_microseconds summary\nhttp_request_duration_microseconds{handler=&quot;app&quot;,quantile=&quot;0.5&quot;} 258.0\nhttp_request_duration_microseconds{handler=&quot;app&quot;,quantile=&quot;0.9&quot;} 258.0\nhttp_request_duration_microseconds{handler=&quot;app&quot;,quantile=&quot;0.99&quot;} 258.0\nhttp_request_duration_microseconds_sum{handler=&quot;app&quot;} 258.0\nhttp_request_duration_microseconds_count{handler=&quot;app&quot;} 1\n# HELP ghc_sparks The number of sparks in the local spark pool.\n# TYPE ghc_sparks gauge\nghc_sparks 0\n# HELP ghc_capabilities The number of threads that can run truly simultaneously.\n# TYPE ghc_capabilities gauge\nghc_capabilities 1\n# HELP ghc_bytes_allocated Total number of bytes allocated.\n# TYPE ghc_bytes_allocated gauge\nghc_bytes_allocated 249136\n# HELP ghc_num_gcs The number of garbage collections performed.\n# TYPE ghc_num_gcs gauge\nghc_num_gcs 3\n# HELP ghc_max_bytes_used The maximum number of live bytes seen so far.\n# TYPE ghc_max_bytes_used gauge\nghc_max_bytes_used 65576\n# HELP ghc_cumulative_bytes_used The cumulative total bytes used.\n# TYPE ghc_cumulative_bytes_used gauge\nghc_cumulative_bytes_used 149136\n# HELP ghc_bytes_copied The number of bytes copied during garbage collection.\n# TYPE ghc_bytes_copied gauge\nghc_bytes_copied 76344\n# HELP ghc_current_bytes_used The number of current live bytes.\n# TYPE ghc_current_bytes_used gauge\nghc_current_bytes_used 65504\n# HELP ghc_current_bytes_slop The current number of bytes lost to slop.\n# TYPE ghc_current_bytes_slop gauge\nghc_current_bytes_slop 0\n# HELP ghc_max_bytes_slop The maximum number of bytes lost to slop so far.\n# TYPE ghc_max_bytes_slop gauge\nghc_max_bytes_slop 8152\n# HELP ghc_peak_megabytes_allocated The maximum number of megabytes allocated.\n# TYPE ghc_peak_megabytes_allocated gauge\nghc_peak_megabytes_allocated 1\n# HELP ghc_mutator_cpu_seconds The CPU time spent running mutator threads.\n# TYPE ghc_mutator_cpu_seconds gauge\nghc_mutator_cpu_seconds 1.471e-3\n# HELP ghc_mutator_wall_seconds The wall clock time spent running mutator threads.\n# TYPE ghc_mutator_wall_seconds gauge\nghc_mutator_wall_seconds 1.48e-3\n# HELP ghc_gc_cpu_seconds The CPU time spent running GC.\n# TYPE ghc_gc_cpu_seconds gauge\nghc_gc_cpu_seconds 1.428e-3\n# HELP ghc_gc_wall_seconds The wall clock time spent running GC.\n# TYPE ghc_gc_wall_seconds gauge\nghc_gc_wall_seconds 1.781416e-3\n# HELP ghc_cpu_seconds Total CPU time elapsed since program start.\n# TYPE ghc_cpu_seconds gauge\nghc_cpu_seconds 0.352497\n# HELP ghc_wall_seconds Total wall clock time elapsed since start.\n# TYPE ghc_wall_seconds gauge\nghc_wall_seconds 28.681236189\n# HELP ghc_parallel_total_bytes_copied Number of bytes copied during GC, minus space held by mutable lists held by the capabilities.\n# TYPE ghc_parallel_total_bytes_copied gauge\nghc_parallel_total_bytes_copied 0\n# HELP ghc_parallel_max_bytes_copied Sum of number of bytes copied\neach GC by the most active GC thread each GC.\n# TYPE ghc_parallel_max_bytes_copied gauge\nghc_parallel_max_bytes_copied 0\n</code></pre>\n","attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":5}).edges.3.node.attributes","generated":true},"__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":5}).edges.3.node.attributes":{"title":"Instrumenting Servant with Prometheus","slug":"instrumenting-servant-with-prometheus","url":"/instrumenting-servant-with-prometheus/","excerpt":"To set up a Servant/WAI application with monitoring, we will first\nscaffold a servant application using stack.","updatedAt":"May 21st, 2016","timeToRead":2,"headerImage":"/4697ea4ccbcd2ba2f293936baed59b9d.png","__typename":"BlogPostAttributes"},"$ROOT_QUERY.root.posts({\"first\":5}).edges.3":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":5}).edges.3.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root.posts({\"first\":5}).edges.4.node":{"body":"<p>Stack yields some nice benefits for blogging, tutorials, and more. The\nmain benefit I want to talk about today is reproducibility when using\nstack to start a new project (in a tutorial).</p>\n<h2 id=\"resolvers\">Resolvers</h2>\n<p>To ensure repeatable resolutions, choose a specific\n<a href=\"https://www.stackage.org/nightly-2016-04-10\">resolver</a>. Since even the nightlies get unique identifiers,\nwe can ensure that any future attempt at reproducing a given tutorial\nis more likely to be successful.</p>\n<h2 id=\"templates\">Templates</h2>\n<p>Stack can use templates from github. Pointing to a specific template,\nwhether custom or from the <a href=\"https://github.com/commercialhaskell/stack-templates\">stack-templates</a> repo, is good\nas well. Cloning git repos could be used as an alternative here, but\none advantage of using Stack‚Äôs support is that you can now have a\nsingle repo of templates and point to a specific git commit/file.</p>\n<h2 id=\"code\">Code</h2>\n<p>A fully qualified reproducible template commmand could look like:</p>\n<pre class=\"highlight__hljs___FzKxy index__p2___65FBl\"><code>stack new servant-users \\\nhttps://raw.githubusercontent.com/commercialhaskell/stack-templates/9a18e8762b8f048d403dabe5c19552ceb5292318/servant.hsfiles \\\n--resolver nightly-2016-04-10\n</code></pre>\n<p>‚Äì note</p>\n<p>Effectively, doing this is trying to freeze the (Hackage) world at a\nspecific point in time for a specific .cabal setup. I‚Äôd argue that\ndoing this is more useful (for tutorials) than trying to make sure a\ntutorial compiles with any arbitrary future set of packages.</p>\n","attributes":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":5}).edges.4.node.attributes","generated":true},"__typename":"BlogPost"},"$ROOT_QUERY.root.posts({\"first\":5}).edges.4.node.attributes":{"title":"Reproducible Tutorials with Stack","slug":"reproducible-tutorials-with-stack","url":"/reproducible-tutorials-with-stack/","excerpt":"Stack yields some nice benefits for blogging, tutorials, and more. The\nmain benefit I want to talk about today is reproducibility when‚Ä¶","updatedAt":"Apr 9th, 2016","timeToRead":1,"headerImage":"/0e564987f79346b0e81685c304af3912.png","__typename":"BlogPostAttributes"},"$ROOT_QUERY.root.posts({\"first\":5}).edges.4":{"node":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":5}).edges.4.node","generated":true},"__typename":"BlogPostEdge"},"$ROOT_QUERY.root":{"posts({\"first\":5})":{"type":"id","id":"$ROOT_QUERY.root.posts({\"first\":5})","generated":true},"post({\"slug\":\"building-a-docker-registry\"})":{"type":"id","id":"$ROOT_QUERY.root.post({\"slug\":\"building-a-docker-registry\"})","generated":true},"__typename":"Query"},"$ROOT_QUERY.root.post({\"slug\":\"building-a-docker-registry\"}).attributes":{"title":"Building a Docker Registry","url":"/building-a-docker-registry/","excerpt":"Containers are surging right now. This series of blog posts will\nexplore a small corner of that universe by building a Docker Registry\nthat‚Ä¶","__typename":"BlogPostAttributes"},"$ROOT_QUERY.root.post({\"slug\":\"building-a-docker-registry\"})":{"attributes":{"type":"id","id":"$ROOT_QUERY.root.post({\"slug\":\"building-a-docker-registry\"}).attributes","generated":true},"__typename":"BlogPost"},"ROOT_QUERY":{"root":{"type":"id","id":"$ROOT_QUERY.root","generated":true}}}}};</script><script src="/js/client.js" charset="UTF-8"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
          ga('create', 'UA-46878058-1', 'auto');
          ga('send', 'pageview');</script></body></html>